# 图形编辑器示例

这是一个工作流程图形编辑器的使用示例，展示了如何使用 CrossModel 内置的 GLSP 图形编辑器创建可视化的工作流程。

> **注意**: 图形编辑器功能已经完全集成到 CrossModel 项目中，位于：
> - 客户端: `packages/glsp-client/src/browser/workflow-diagram/`
> - 服务器端: `packages/server/src/glsp-server/workflow-diagram/`

## 功能特性

### 图形编辑功能
- **可视化节点创建**: 通过工具栏拖拽创建各种类型的工作流程节点
- **节点连接**: 可视化地连接节点创建工作流程
- **节点编辑**: 双击节点编辑属性和配置
- **布局管理**: 自动布局和手动调整节点位置

### 支持的节点类型
- **开始节点** (●): 流程的入口点
- **结束节点** (●): 流程的出口点  
- **处理节点** (□): 执行业务逻辑的节点
- **决策节点** (◇): 条件分支节点
- **决策表节点** (⊞): 复杂决策逻辑表格
- **并行节点** (‖): 并发处理节点
- **子流程节点** (⊕): 嵌套子流程
- **自动化节点** (⚙): 自动化任务
- **API节点** (☁): API调用节点

### 高级功能
- **泳道支持**: 按角色或部门组织节点
- **实时同步**: 与DSL文本编辑器和表单编辑器实时同步
- **撤销/重做**: 完整的操作历史管理
- **导入/导出**: 支持多种格式的导入导出

## 文件结构

```
diagram-editor-example/
├── README.md                           # 本文档
├── demo.md                             # 演示指南
├── workflows/                          # 示例工作流程文件
│   └── CompleteExample.workflow.cm     # 完整功能演示
└── diagrams/                           # 导出的图形文件
    ├── complete-example.png            # 流程图截图
    └── complete-example.svg            # 矢量图形
```

> **图形编辑器源代码位置**:
> - 前端组件: `packages/glsp-client/src/browser/workflow-diagram/`
> - 后端服务: `packages/server/src/glsp-server/workflow-diagram/`
> - 样式文件: `packages/glsp-client/style/`

## 使用方法

### 1. 启动 CrossModel 应用

```bash
# 在项目根目录
yarn install
yarn build
yarn start:electron  # 或 yarn start:browser
```

### 2. 打开示例文件

1. 在 CrossModel 中打开 `examples/workflow-examples/diagram-editor-example/workflows/CompleteExample.workflow.cm`
2. 你将看到三个编辑器标签页：
   - **Text Editor**: DSL代码编辑器
   - **Diagram Editor**: 图形化流程编辑器 ← **这就是图形编辑器！**
   - **Form Editor**: 表单化属性编辑器

### 3. 使用图形编辑器

点击 **Diagram Editor** 标签页，你将看到：
- 左侧工具面板：包含所有可创建的节点类型
- 中央画布：可视化的流程图
- 属性面板：选中元素的属性编辑

## 图形编辑器功能演示

### 创建新节点

1. **选择节点类型**: 从左侧工具栏选择要创建的节点
2. **放置节点**: 在画布上点击放置节点
3. **编辑属性**: 双击节点编辑名称和属性

#### 可用节点类型

| 图标 | 节点类型 | 用途 |
|------|----------|------|
| ● | 开始节点 | 流程入口点 |
| □ | 处理节点 | 业务逻辑处理 |
| ◇ | 决策节点 | 条件分支 |
| ⊞ | 决策表 | 复杂决策逻辑 |
| ‖ | 并行节点 | 并发处理 |
| ⊕ | 子流程 | 嵌套流程 |
| ⚙ | 自动化 | 自动化任务 |
| ☁ | API节点 | 外部服务调用 |
| ● | 结束节点 | 流程出口点 |

### 连接节点

1. **选择连接工具**: 点击工具栏中的 → 图标
2. **创建连接**: 从源节点拖拽到目标节点
3. **编辑条件**: 双击连接线编辑条件和标签

### 使用泳道

1. **创建泳道**: 右键画布选择"创建泳道"
2. **拖拽节点**: 将节点拖入泳道进行分组
3. **编辑泳道**: 双击泳道编辑名称和颜色

## 实时同步演示

### 三种编辑器同步

1. **在图形编辑器中**: 创建一个新的处理节点
2. **切换到文本编辑器**: 查看自动生成的DSL代码
3. **切换到表单编辑器**: 查看结构化的属性表单
4. **在任一编辑器中修改**: 其他编辑器实时更新

### 验证和错误提示

1. **创建无效连接**: 尝试从结束节点连接到其他节点
2. **查看错误提示**: 编辑器显示红色错误标记
3. **修复错误**: 删除无效连接，错误标记消失

## 示例工作流程解析

### CompleteExample.workflow.cm 包含：

#### 1. 基础流程控制
- 开始节点 → 输入验证 → 决策检查
- 展示了基本的顺序和分支流程

#### 2. 决策表应用
- 优先级评估节点使用决策表
- 根据用户等级、紧急程度、业务影响决定处理策略

#### 3. 并行处理
- 并行开始节点分出三个分支：
  - 数据处理分支
  - 通知发送分支  
  - 外部API调用分支
- 并行结束节点等待所有分支完成

#### 4. 高级节点应用
- 子流程节点调用清理流程
- 自动化节点生成报告
- API节点调用外部服务

#### 5. 错误处理
- 输入验证失败时的错误处理分支
- 异常结束节点处理错误情况

#### 6. 泳道组织
- 用户操作泳道：用户相关的节点
- 系统处理泳道：自动化处理节点
- 后处理泳道：清理和报告节点
- 错误处理泳道：异常处理节点

## 交互操作

### 快捷键

```
Ctrl+S          → 保存流程
Ctrl+Z          → 撤销操作
Ctrl+Y          → 重做操作
Delete          → 删除选中元素
Ctrl+A          → 全选
Ctrl+C          → 复制
Ctrl+V          → 粘贴
Ctrl+0          → 缩放到适合
```

### 右键菜单

- **节点右键**: 编辑属性、创建引用、删除节点
- **连接右键**: 编辑条件、删除连接
- **画布右键**: 创建节点、创建泳道、粘贴

## 验收测试清单

使用这个示例验证图形编辑器功能：

### ✅ 基本功能
- [ ] 能够打开 .workflow.cm 文件并显示图形视图
- [ ] 三种编辑器（Text/Diagram/Form）可以正常切换
- [ ] 工具面板显示所有节点类型
- [ ] 可以创建各种类型的节点
- [ ] 可以连接节点创建流程
- [ ] 可以编辑节点属性

### ✅ 高级功能
- [ ] 决策表节点可以编辑表格数据
- [ ] 泳道功能正常工作
- [ ] 并行节点支持多分支
- [ ] 引用节点功能正常
- [ ] 实时同步在三种编辑器间工作

### ✅ 用户体验
- [ ] 拖拽操作流畅
- [ ] 撤销/重做功能正常
- [ ] 错误提示清晰
- [ ] 性能表现良好

## 故障排除

### 常见问题

1. **图形编辑器不显示**
   - 确认 GLSP 服务器正在运行
   - 检查浏览器控制台是否有错误

2. **节点无法创建**
   - 检查是否选择了正确的工具
   - 确认画布区域可点击

3. **同步问题**
   - 检查语言服务器连接
   - 查看浏览器控制台错误

## 相关文档

- [CrossModel 架构文档](../../../docs/Architecture.md)
- [工作流程DSL语法参考](../../../docs/workflow/DSL-Reference.md)
- [GLSP集成指南](../../../docs/GLSP-Integration.md)
- [开发者指南](../../../CONTRIBUTING.md)

## 总结

这个示例展示了 CrossModel 中完全集成的图形编辑器功能。图形编辑器不是一个独立的组件，而是 CrossModel 应用的核心功能之一，与文本编辑器和表单编辑器无缝集成，提供完整的三种建模方式。