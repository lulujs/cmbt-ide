# 图形编辑器演示指南

这个演示展示了如何使用 CrossModel 内置的工作流程图形编辑器创建、编辑和管理业务流程。

> **重要**: 图形编辑器是 CrossModel 的内置功能，不需要单独安装或启动。

## 快速开始

### 1. 启动 CrossModel

```bash
# 在项目根目录
yarn install
yarn build

# 启动桌面版
yarn start:electron

# 或启动浏览器版
yarn start:browser
```

### 2. 打开示例文件

1. 在 CrossModel 中，使用 File → Open 打开文件
2. 导航到 `examples/workflow-examples/diagram-editor-example/workflows/CompleteExample.workflow.cm`
3. 文件将在编辑器中打开，显示三个标签页：
   - **Text Editor**: DSL代码编辑
   - **Diagram Editor**: 图形化编辑 ← **这就是图形编辑器！**
   - **Form Editor**: 表单化编辑

### 3. 切换到图形编辑器

点击 **Diagram Editor** 标签页，你将看到完整的图形编辑界面。

## 图形编辑器功能演示

### 创建新节点

1. **选择节点类型**: 从左侧工具栏选择要创建的节点
2. **放置节点**: 在画布上点击放置节点
3. **编辑属性**: 双击节点编辑名称和属性

#### 可用节点类型

| 图标 | 节点类型 | 用途 |
|------|----------|------|
| ● | 开始节点 | 流程入口点 |
| □ | 处理节点 | 业务逻辑处理 |
| ◇ | 决策节点 | 条件分支 |
| ⊞ | 决策表 | 复杂决策逻辑 |
| ‖ | 并行节点 | 并发处理 |
| ⊕ | 子流程 | 嵌套流程 |
| ⚙ | 自动化 | 自动化任务 |
| ☁ | API节点 | 外部服务调用 |
| ● | 结束节点 | 流程出口点 |

### 连接节点

1. **选择连接工具**: 点击工具栏中的 → 图标
2. **创建连接**: 从源节点拖拽到目标节点
3. **编辑条件**: 双击连接线编辑条件和标签

### 使用泳道

1. **创建泳道**: 右键画布选择"创建泳道"
2. **拖拽节点**: 将节点拖入泳道进行分组
3. **编辑泳道**: 双击泳道编辑名称和颜色

### 高级功能

#### 决策表编辑
1. 双击决策表节点
2. 在弹出的表格编辑器中编辑规则
3. 系统自动根据输出列创建连接

#### 并行流程
1. 创建并行开始节点 (‖)
2. 连接多个并行分支
3. 创建并行结束节点汇聚

#### 子流程引用
1. 创建子流程节点 (⊕)
2. 设置引用的子流程文件路径
3. 配置输入输出参数

## 实时同步演示

### 三种编辑器同步

1. **在图形编辑器中**: 创建一个新的处理节点
2. **切换到文本编辑器**: 查看自动生成的DSL代码
3. **切换到表单编辑器**: 查看结构化的属性表单
4. **在任一编辑器中修改**: 其他编辑器实时更新

### 验证和错误提示

1. **创建无效连接**: 尝试从结束节点连接到其他节点
2. **查看错误提示**: 编辑器显示红色错误标记
3. **修复错误**: 删除无效连接，错误标记消失

## 示例工作流程解析

### CompleteExample.workflow.cm 包含：

#### 1. 基础流程控制
- 开始节点 → 输入验证 → 决策检查
- 展示了基本的顺序和分支流程

#### 2. 决策表应用
- 优先级评估节点使用决策表
- 根据用户等级、紧急程度、业务影响决定处理策略

#### 3. 并行处理
- 并行开始节点分出三个分支：
  - 数据处理分支
  - 通知发送分支  
  - 外部API调用分支
- 并行结束节点等待所有分支完成

#### 4. 高级节点应用
- 子流程节点调用清理流程
- 自动化节点生成报告
- API节点调用外部服务

#### 5. 错误处理
- 输入验证失败时的错误处理分支
- 异常结束节点处理错误情况

#### 6. 泳道组织
- 用户操作泳道：用户相关的节点
- 系统处理泳道：自动化处理节点
- 后处理泳道：清理和报告节点
- 错误处理泳道：异常处理节点

## 交互操作演示

### 基本操作

```
选择工具 (V)     → 选择和移动节点
连接工具 (E)     → 创建节点连接
删除工具 (D)     → 删除选中元素
```

### 快捷键

```
Ctrl+S          → 保存流程
Ctrl+Z          → 撤销操作
Ctrl+Y          → 重做操作
Delete          → 删除选中元素
Ctrl+A          → 全选
Ctrl+C          → 复制
Ctrl+V          → 粘贴
Ctrl+0          → 缩放到适合
```

### 右键菜单

- **节点右键**: 编辑属性、创建引用、删除节点
- **连接右键**: 编辑条件、删除连接
- **画布右键**: 创建节点、创建泳道、粘贴

## 导出和分享

### 导出图片
```javascript
// 导出为PNG
const pngData = await diagramWidget.exportAsImage('png');

// 导出为SVG  
const svgData = await diagramWidget.exportAsImage('svg');
```

### 导出DSL代码
```javascript
// 获取DSL代码
const dslCode = diagramWidget.getDSLCode();
```

### 分享流程
1. 保存工作流程文件 (.workflow.cm)
2. 导出图片用于文档
3. 分享DSL代码用于版本控制

## 扩展和定制

### 添加自定义节点类型

1. **定义语义模型**: 在DSL中添加新节点类型
2. **创建图形视图**: 实现节点的可视化渲染
3. **添加操作处理**: 实现创建、编辑、删除操作
4. **更新工具栏**: 在工具面板中添加新节点

### 自定义样式主题

编辑 `src/styles/diagram-theme.css` 文件：

```css
/* 自定义节点颜色 */
.my-custom-node rect {
    fill: #your-color;
    stroke: #your-border-color;
}
```

### 添加验证规则

```typescript
export class CustomValidator implements ModelValidator {
    validate(model: WorkflowModel): ValidationResult[] {
        // 自定义验证逻辑
        return validationResults;
    }
}
```

## 故障排除

### 常见问题

1. **节点无法创建**
   - 检查是否选择了正确的工具
   - 确认画布区域可点击

2. **连接失败**
   - 验证源节点和目标节点兼容性
   - 检查连接规则约束

3. **同步问题**
   - 检查语言服务器连接
   - 查看浏览器控制台错误

### 调试模式

```bash
# 启用调试模式
npm run start:debug

# 查看详细日志
# 打开浏览器开发者工具查看控制台
```

## 下一步

- 尝试创建自己的工作流程
- 探索高级功能如决策表和并行处理
- 学习DSL语法进行文本编辑
- 了解如何扩展和定制编辑器

更多信息请参考：
- [完整文档](../README.md)
- [DSL语法参考](../../../docs/workflow/DSL-Reference.md)
- [API文档](../../../docs/api/README.md)